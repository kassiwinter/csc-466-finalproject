Credit...J. Scott Applewhite/Associated PressMay 18, 2018WASHINGTON — The factional rancor threatening Republicans heading into the midterm elections this fall erupted into the open on Friday when a slugfest among moderates, hard-line conservatives and House leaders over immigration and welfare policy sank the party’s multiyear farm bill.The twice-a-decade measure — which would have imposed strict new work requirements on food aid recipients while maintaining farm subsidies important to rural lawmakers — failed on a 213-to-198 vote. It was a rebuke of Speaker Paul D. Ryan by a key bloc of conservatives over his refusal to schedule an immediate vote on a restrictive immigration bill sponsored by the chairman of the House Judiciary Committee.Republican moderates, for their part, were moving in the opposite direction, shrugging off the pleas of their leaders as they worked toward forcing votes on legislation to protect from deportation young immigrants brought to the country illegally as children.The fights were striking, not only because of their intensity but also because of the participants. Capitol Hill has grown used to altercations between Republican leaders and their adamant right flank — showdowns that have shut down the government and edged the government toward defaulting on its debt. But in past fights, the party’s moderates have proved compliant.This time, with their districts dominating the Democrats’ target list for the coming midterm races, the moderates are holding firm to their own demands.“I have asked the speaker every single week, give us a timeline when these bills, when we can have a full debate in front of the American people, and we failed to get one, and so we’re forcing one,” Representative Jeff Denham, Republican of California, who faces a tough re-election challenge, said on CNN.Mr. Ryan and Kevin McCarthy, the House majority leader, tried but did not succeed in heading off the revolts after appeals for unity and intense negotiations with members of the hard-line House Freedom Caucus. Mr. Ryan told colleagues he refused to be held hostage by the upstarts, then gambled that he would find enough votes to pass the legislation, despite unified Democratic opposition.But that support never materialized, dealing a blow to Mr. Ryan, who recently announced his intention to retire next year. Thirty Republicans voted against the bill, a group that included the rebellious conservatives and some moderate lawmakers.“I thought we had enough people that would vote yes,” said Representative Patrick T. McHenry, Republican of North Carolina and the chief deputy whip.In reality, the farm bill, which has huge implications for low-income families and the agricultural industry, largely became a bargaining chip in the heated intraparty battle over immigration, President Trump’s core cultural and political issue.Representative Jim Jordan, Republican of Ohio and a founder of the Freedom Caucus, said lawmakers needed to reach a resolution on immigration “that’s consistent with the mandate of the election” that put Mr. Trump in the White House.“That’s all this was about,” said Mr. Jordan, a possible candidate to succeed Mr. Ryan, after voting against the measure.The collapse of the bill is a significant loss for Mr. Trump, who had pressured Republican leaders to include new work rules in the measure and had called it “strong” in a Twitter post on Thursday.And it was a humbling setback for Mr. Ryan, raising questions about his ability to run an already fractious Republican conference as a lame duck. It also raised questions about the capacity of his possible successors, including Mr. McCarthy and the majority whip, Steve Scalise of Louisiana, to legislate effectively.Shortly after the bill failed, Mr. McHenry told reporters that another challenge to leadership, coming from the party’s moderates, seemed on the brink of success. A group of Republicans have signed a procedural petition that would force a series of votes on immigration bills.The moderate lawmakers are seeking action by the House to address the future of the Deferred Action for Childhood Arrivals program, or DACA, an Obama-era initiative that protects young immigrants brought to the country illegally as children. Mr. Trump moved last year to end the program, though the courts have kept it alive.For the petition to succeed, it needs 25 Republicans to sign on, assuming every Democrat does as well. By Friday, 20 Republicans had.Over the past week, Mr. Ryan had been working quietly with moderates on a deal that would bring immigration legislation to the floor in June, opening up the possibility for a bipartisan breakthrough on the issue. But conservatives wanted a vote on the hard-line bill sponsored by the Judiciary Committee chairman, Representative Robert W. Goodlatte, much sooner than that.Mr. McCarthy agreed to bring Mr. Goodlatte’s bill to the floor, but the Freedom Caucus balked at the timing.“This is all the more disappointing because we offered the vote these members were looking for, but they still chose to take the bill down,” Doug Andres, a spokesman for Mr. Ryan, said.Despite all the drama, the House action on both issues, the farm bill and immigration, is not expected to be decisive. Any DACA deal will require buy-in from Mr. Trump, who has demanded billions in funding for a border wall with Mexico.The House’s farm bill was already destined to be set aside by the Senate, which has been working on its own bipartisan measure. The farm legislation will need 60 votes in the Senate, meaning that Republicans, even if they are unified, will not be able to pass a partisan bill in that chamber.The farm bill, despite its pastoral name, is one of the most politically sensitive policy bills that Congress is required to pass. Passage is invariably engineered by a coalition of urban Democratic legislators seeking to maintain food assistance under attack from conservative budget cutters, and rural Republicans determined to shield subsidies for sugar, corn, cotton and other commodities.This year’s bill has become something of an M.R.I. into the soul of the Republican Party before the midterms, revealing divisions, dysfunction and jockeying agendas in Congress and the West Wing.The bill was shepherded along by the chairman of the House Agriculture Committee, K. Michael Conaway, Republican of Texas.But enthusiasm in the party for the new work rules is not universal. Agriculture Secretary Sonny Perdue supports the plan, in principle, but has been prodded by Mr. Trump’s domestic policy adviser Andrew Bremberg to take more decisive action on the issue, according to two administration officials.Mr. Conaway and other mainstream Republicans from rural areas wanted to preserve backbone agricultural supports while fighting back challenges from the right to reduce subsidies. But he also sought to accommodate the White House and outside conservative groups, which demanded new election-year initiatives to reduce the rolls of the Supplemental Nutrition Assistance Program, or SNAP, which Mr. Trump regards, along with Medicaid and housing aid, as “welfare.”The House bill would impose tougher work requirements for those receiving food stamps, mandating that adults spend 20 hours a week working or participating in job training, with some exceptions, such as for caretakers of young children.But the changes to SNAP, formerly known as food stamps, alienated Democrats. “This bad bill steals food off the tables of children, seniors, students,” Representative Nancy Pelosi of California, the House Democratic leader, said this week.It was unclear when House Republican leaders might try again to pass the farm bill. The current measure expires at the end of September.“Good riddance to the House G.O.P. farm bill, which was both cruel and counterproductive,” said Joel Berg, the chief executive of Hunger Free America, a nationwide advocacy group that opposed the work requirements provision. “The bill, if passed, would have somehow managed to take food away from millions of struggling Americans while increasing government bureaucracy and intrusion into people’s private lives.”Mr. Conaway said Republicans would press on after Friday’s stumble.“We may be down, but we are not out,” he said. “We will deliver a strong new farm bill on time as the president of the United States has called on us to do.”